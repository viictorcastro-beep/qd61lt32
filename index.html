<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Custos de Obra - V&G</title>
    
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none !important; }
        .modal-overlay { transition: opacity 0.2s ease-in-out; }
        .progress-bar-bg { background-color: #e5e7eb; }
        .progress-bar { transition: width 0.3s ease-in-out; }
        .loader { border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #fff; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl shadow-lg p-8 max-w-sm w-full text-center">
            <h1 class="text-2xl font-bold mb-2">Gestor de Custos — V&G</h1>
            <p class="text-sm text-slate-600 mb-5">Acesse com Google para abrir o painel colaborativo.</p>
            <button id="login-btn" class="bg-slate-900 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center w-full gap-3">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.018,36.33,44,30.651,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                Entrar com Google
            </button>
            <p id="login-msg" class="text-xs text-red-600 mt-4 h-4"></p>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
         <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
            <header class="mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                     <h1 id="main-title" class="text-3xl font-bold text-slate-900">Gestor de Custos de Obra</h1>
                     <div id="user-info" class="flex items-center gap-4">
                        <img id="user-photo" class="w-10 h-10 rounded-full">
                        <span id="user-name" class="font-semibold"></span>
                        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Sair</button>
                    </div>
                </div>
                 <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                    <div class="p-4 bg-slate-200 rounded-lg flex flex-wrap gap-4 items-center">
                        <span class="font-semibold">Sócios:</span>
                        <input type="text" id="participant-a" class="px-2 py-1 font-bold border rounded-md w-32">
                        <span>&</span>
                        <input type="text" id="participant-b" class="px-2 py-1 font-bold border rounded-md w-32">
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button id="history-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Histórico</button>
                        <button id="manage-budget-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Orçamento</button>
                        <button id="export-pdf-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Exportar PDF</button>
                    </div>
                </div>
            </header>
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <section><h2 class="text-2xl font-bold mb-4 text-slate-800">Dashboard da Obra</h2><div id="dashboard-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div></section>
                    <section id="balanca-acerto-card" class="p-6 rounded-2xl shadow-lg text-center"><h2 class="text-xl font-bold mb-2">Balança de Acerto</h2><div id="balanca-content"></div></section>
                    <section class="bg-white p-6 rounded-2xl shadow-lg">
                        <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Novo Lançamento</h2><button id="quick-add-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Rápido</button></div>
                        <form id="lancamento-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <input type="date" id="dt" class="sm:col-span-1 border p-2 rounded-md" required>
                            <input type="text" id="desc" placeholder="Descrição" class="sm:col-span-3 border p-2 rounded-md" required>
                            <select id="cat" class="border p-2 rounded-md"></select>
                            <select id="cc" class="border p-2 rounded-md"></select>
                            <input type="text" id="valor" placeholder="Valor" class="border p-2 rounded-md" required>
                            <select id="pagador" class="border p-2 rounded-md"></select>
                            <div><label id="label-pa" class="text-sm">Sócio A (%):</label><input type="number" id="pA" step="0.01" min="0" max="1" value="0.5" class="w-full border p-2 rounded-md" required></div>
                            <div><label id="label-pb" class="text-sm">Sócio B (%):</label><input type="number" id="pB" step="0.01" min="0" max="1" value="0.5" class="w-full border p-2 rounded-md" required></div>
                            <input type="file" id="anexo" accept=".pdf,.jpeg,.jpg,.png" class="sm:col-span-4 border p-2 rounded-md file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <div class="sm:col-span-4 flex flex-wrap items-center gap-4"><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md flex items-center justify-center gap-2">Adicionar</button></div>
                        </form>
                    </section>
                     <section class="bg-white p-6 rounded-2xl shadow-lg">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4"><h2 class="text-xl font-bold">Lançamentos</h2><div class="flex items-center gap-2"><label for="filter-cc" class="text-sm font-medium">Filtrar por CC:</label><select id="filter-cc" class="border p-2 rounded-md text-sm"></select></div></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100"><tr><th class="p-2">Data</th><th class="p-2">Descrição</th><th class="p-2">Valor</th><th class="p-2">Pagador</th><th class="p-2">Anexo</th><th class="p-2">Ação</th></tr></thead><tbody id="lancamentos-table-body"></tbody></table></div>
                    </section>
                </div>
                <aside class="space-y-8">
                    <section><h2 class="text-2xl font-bold mb-4 text-slate-800">Resumo Financeiro</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div class="bg-white p-4 rounded-2xl shadow-md text-center"><h3 class="text-sm font-semibold text-slate-500">Total Geral</h3><p id="kpi-total" class="text-2xl font-bold"></p></div><div class="bg-yellow-100 border border-yellow-300 p-4 rounded-2xl shadow-md text-center"><h3 class="text-sm font-semibold text-slate-600">Equalização</h3><p id="kpi-equalizacao" class="text-xl font-bold"></p></div></div></section>
                    <section class="bg-white p-6 rounded-2xl shadow-lg"><h2 class="text-xl font-bold mb-4">Acertos</h2><form id="acerto-form" class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label for="de" class="block text-sm">De:</label><select id="de" class="w-full border p-2 rounded-md"></select></div><div><label for="para" class="block text-sm">Para:</label><select id="para" class="w-full border p-2 rounded-md"></select></div></div><div><label for="valor-acerto" class="block text-sm">Valor:</label><input type="text" id="valor-acerto" class="w-full border p-2 rounded-md" required></div><div><label for="anexo-acerto" class="block text-sm">Anexo:</label><input type="file" id="anexo-acerto" class="w-full border p-2 rounded-md"></div><div class="flex gap-2"><button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-md shadow-sm flex items-center justify-center gap-2">Registrar</button><button type="button" id="sugestao-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-md shadow-sm">Sugestão</button></div></form><div class="mt-6"><h3 class="font-semibold mb-2">Histórico de Acertos</h3><ul id="acertos-list" class="space-y-2 text-sm"></ul></div></section>
                    <section class="bg-white p-6 rounded-2xl shadow-lg"><h2 class="text-xl font-bold mb-4">Detalhes por Sócio</h2><div id="resumo-socios" class="space-y-4"></div></section>
                </aside>
            </main>
        </div>
        <div id="quick-add-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-md"><h2 class="text-xl font-bold mb-4">Lançamento Rápido</h2><form id="quick-add-form"><div class="space-y-4"><input type="text" id="quick-desc" class="w-full border p-2 rounded-md" placeholder="Descrição" required><input type="text" id="quick-valor" class="w-full border p-2 rounded-md" placeholder="Valor" required><select id="quick-pagador" class="w-full border p-2 rounded-md"></select></div><div class="flex gap-4 mt-6"><button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 rounded-md">Adicionar</button><button type="button" id="quick-add-cancel" class="w-full bg-gray-300 hover:bg-gray-400 font-bold py-2 rounded-md">Cancelar</button></div></form></div></div>
        <div id="budget-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-2xl max-h-[90vh] flex flex-col"><h2 class="text-xl font-bold mb-4">Gerir Orçamento</h2><form id="budget-form" class="flex-grow overflow-y-auto pr-2"><div id="budget-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></form><div class="flex gap-4 mt-6 pt-4 border-t"><button type="button" id="budget-save" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 rounded-md">Salvar</button><button type="button" id="budget-cancel" class="w-full bg-gray-300 hover:bg-gray-400 font-bold py-2 rounded-md">Cancelar</button></div></div></div>
        <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-3xl max-h-[90vh] flex flex-col"><h2 class="text-xl font-bold mb-4">Histórico de Eventos</h2><div id="history-content" class="flex-grow overflow-y-auto pr-2 text-sm"></div><div class="mt-6 pt-4 border-t"><button type="button" id="history-close" class="w-full bg-gray-300 hover:bg-gray-400 font-bold py-2 rounded-md">Fechar</button></div></div></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA9GTueuXozK7FZPl-MSnXfbn4d9ex2Mm8",
            authDomain: "qd61lt32.firebaseapp.com",
            projectId: "qd61lt32",
            storageBucket: "qd61lt32.firebasestorage.app",
            messagingSenderId: "636694484879",
            appId: "1:636694484879:web:9f321f56f1e72895c25dfa",
            measurementId: "G-QT2KJL124T"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        const lancamentosCol = collection(db, "lancamentos");
        const acertosCol = collection(db, "acertos");
        const configDocRef = doc(db, "config", "main");
        const historyCol = collection(db, "history");

        const loginScreen = document.getElementById('login-screen');
        const appWrapper = document.getElementById('app-wrapper');
        const loadingOverlay = document.getElementById('loading-overlay');

        let currentUser = null;
        let state = { lancamentos: [], acertos: [], config: null, history: [] };
        let listeners = [];
        let cachedCalculations = {};
        
        const PREDEFINED_LISTS = {
            categorias: ['Outros', 'Terreno', 'Projeto', 'Material', 'Mão de Obra', 'Serviços', 'Licenças/Taxas', 'Transporte/Logística'],
            centrosDeCusto: ['Outros', 'Terreno', 'Projeto', 'Fundações', 'Estrutura/Alvenaria', 'Cobertura', 'Elétrica', 'Hidráulica', 'Revestimentos/Pisos', 'Esquadrias/Vidros', 'Pintura', 'Paisagismo', 'Licenças/Taxas', 'Equalização'],
        };
        const fmt = (n) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(n || 0);
        const parseNum = (v) => parseFloat(String(v || '').replace(/\./g, '').replace(',', '.')) || 0;
        const ALLOW_EMAILS = new Set(['viictor.castro@gmail.com', 'gcm.conceicao@gmail.com']);

        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => {
                console.error("Login Error:", error);
                const msgEl = document.getElementById('login-msg');
                if(error.code === 'auth/unauthorized-domain') {
                    msgEl.textContent = 'Domínio não autorizado. Verifique a configuração no Firebase.';
                } else {
                    msgEl.textContent = 'Erro ao fazer login.';
                }
            });
        });

        onAuthStateChanged(auth, user => {
            if (user && ALLOW_EMAILS.has(user.email)) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                loadingOverlay.classList.remove('hidden');
                appWrapper.classList.remove('hidden');
                addEventListeners();
                setupRealtimeListeners();
            } else {
                if (user) signOut(auth);
                currentUser = null;
                appWrapper.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                listeners.forEach(unsubscribe => unsubscribe());
                listeners = [];
            }
        });

        async function logEvent(action, details = {}) {
            if (!currentUser) return;
            try {
                await addDoc(historyCol, { action, details, user: currentUser.displayName, email: currentUser.email, timestamp: serverTimestamp() });
            } catch (error) { console.error("Log Error:", error); }
        }
        
        function setupRealtimeListeners() {
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];
            let dataLoaded = { lancamentos: false, acertos: false, config: false };

            const onAllDataLoaded = () => {
                if (Object.values(dataLoaded).every(Boolean)) {
                    loadingOverlay.classList.add('hidden');
                    rerender();
                }
            };

            const unsubLancamentos = onSnapshot(query(lancamentosCol, orderBy("dt", "desc")), snap => { state.lancamentos = snap.docs.map(d => ({...d.data(), id: d.id })); dataLoaded.lancamentos = true; onAllDataLoaded(); });
            const unsubAcertos = onSnapshot(query(acertosCol, orderBy("dt", "desc")), snap => { state.acertos = snap.docs.map(d => ({...d.data(), id: d.id })); dataLoaded.acertos = true; onAllDataLoaded(); });
            const unsubConfig = onSnapshot(configDocRef, doc => { 
                state.config = doc.exists() ? doc.data() : { a: 'Sócio A', b: 'Sócio B', budget: { cc: {} } };
                dataLoaded.config = true;
                onAllDataLoaded();
            });
            const unsubHistory = onSnapshot(query(historyCol, orderBy("timestamp", "desc")), snap => { state.history = snap.docs.map(d => d.data()); renderHistoryModal(); });
            
            listeners.push(unsubLancamentos, unsubAcertos, unsubConfig, unsubHistory);
        }
        
        function compute() {
            if (!state.config) return;
            const { lancamentos, acertos, config } = state;
            const { a, b } = config;
            
            const totalGeral = lancamentos.reduce((s, l) => s + l.valor, 0);
            const pagoPorA = lancamentos.filter(l => l.pagador === a).reduce((s, l) => s + l.valor, 0);
            const pagoPorB = lancamentos.filter(l => l.pagador === b).reduce((s, l) => s + l.valor, 0);
            const devidoPorA = lancamentos.reduce((s, l) => s + (l.valor * (l.pA || 0.5)), 0);
            const devidoPorB = lancamentos.reduce((s, l) => s + (l.valor * (l.pB || 0.5)), 0);
            
            const acertosRecebidosA = acertos.filter(ac => ac.para === a).reduce((s, ac) => s + ac.valor, 0);
            const acertosPagosA = acertos.filter(ac => ac.de === a).reduce((s, ac) => s + ac.valor, 0);
            const saldoPosAcertosA = (pagoPorA - devidoPorA) + acertosRecebidosA - acertosPagosA;

            const acertosRecebidosB = acertos.filter(ac => ac.para === b).reduce((s, ac) => s + ac.valor, 0);
            const acertosPagosB = acertos.filter(ac => ac.de === b).reduce((s, ac) => s + ac.valor, 0);
            const saldoPosAcertosB = (pagoPorB - devidoPorB) + acertosRecebidosB - acertosPagosB;

            let equalizacao = { valor: 0, texto: 'Saldos zerados' };
            if (saldoPosAcertosA > 0.01) {
                equalizacao = { valor: saldoPosAcertosA, de: b, para: a, texto: `${b} paga ${fmt(saldoPosAcertosA)}` };
            } else if (saldoPosAcertosB > 0.01) {
                equalizacao = { valor: saldoPosAcertosB, de: a, para: b, texto: `${a} paga ${fmt(saldoPosAcertosB)}` };
            }

            const realizadoPorCC = lancamentos.reduce((acc, l) => { acc[l.cc] = (acc[l.cc] || 0) + l.valor; return acc; }, {});
            
            cachedCalculations = { totalGeral, pagoPorA, pagoPorB, devidoPorA, devidoPorB, saldoPosAcertosA, saldoPosAcertosB, equalizacao, realizadoPorCC };
        }

        function rerender() {
            if (!state.config || !document.getElementById('app')) return;
            compute();
            
            const { a, b } = state.config;
            document.getElementById('user-photo').src = currentUser.photoURL;
            document.getElementById('user-name').textContent = currentUser.displayName;
            document.getElementById('participant-a').value = a;
            document.getElementById('participant-b').value = b;
            document.getElementById('label-pa').textContent = `${a} (%):`;
            document.getElementById('label-pb').textContent = `${b} (%):`;

            populateSelects();
            renderDashboard();
            renderBalanca();
            renderLancamentos();
            renderAcertos();
            renderResumoSocios();
            document.getElementById('kpi-total').textContent = fmt(cachedCalculations.totalGeral);
            document.getElementById('kpi-equalizacao').textContent = cachedCalculations.equalizacao.texto;
        }
        
        function populateSelects() {
            const { a, b } = state.config;
            const pagadores = [a, b];
            const createOptions = arr => arr.map(item => `<option value="${item}">${item}</option>`).join('');
            
            ['cat', 'cc', 'pagador', 'de', 'para', 'quick-pagador', 'filter-cc'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const currentValue = el.value;
                    if (id === 'cat') el.innerHTML = createOptions(PREDEFINED_LISTS.categorias);
                    else if (id === 'cc' || id === 'filter-cc') {
                        const options = id === 'filter-cc' ? ['Todos', ...PREDEFINED_LISTS.centrosDeCusto] : PREDEFINED_LISTS.centrosDeCusto;
                        el.innerHTML = createOptions(options);
                    }
                    else if (['pagador', 'de', 'para', 'quick-pagador'].includes(id)) el.innerHTML = createOptions(pagadores);
                    if (currentValue) el.value = currentValue;
                }
            });
        }

        function renderDashboard() {
            const budget = state.config.budget || { cc: {} };
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = PREDEFINED_LISTS.centrosDeCusto.map(cc => {
                const orcado = budget.cc[cc] || 0;
                const realizado = cachedCalculations.realizadoPorCC[cc] || 0;
                const saldo = orcado - realizado;
                const percent = orcado > 0 ? (realizado / orcado) * 100 : 0;
                let barColor = 'bg-green-500';
                if (percent > 80 && percent <= 100) barColor = 'bg-yellow-500';
                if (percent > 100) barColor = 'bg-red-500';
                return `<div class="bg-white p-4 rounded-2xl shadow-md">
                    <h4 class="font-bold">${cc}</h4>
                    <div class="text-sm mt-2 space-y-1">
                        <p class="flex justify-between"><span>Orçado:</span> <span>${fmt(orcado)}</span></p>
                        <p class="flex justify-between"><span>Realizado:</span> <span class="font-semibold">${fmt(realizado)}</span></p>
                        <p class="flex justify-between"><span>Saldo:</span> <span class="${saldo < 0 ? 'text-red-600' : ''}">${fmt(saldo)}</span></p>
                    </div>
                    <div class="w-full progress-bar-bg rounded-full h-2.5 mt-3"><div class="${barColor} h-2.5 rounded-full" style="width: ${Math.min(percent, 100)}%"></div></div>
                </div>`;
            }).join('');
        }
        
        function renderBalanca() {
             const { saldoPosAcertosA } = cachedCalculations;
            const { a, b } = state.config;
            const card = document.getElementById('balanca-acerto-card');
            const content = document.getElementById('balanca-content');
            if (Math.abs(saldoPosAcertosA) < 0.01) {
                card.className = 'p-6 rounded-2xl shadow-lg text-center bg-green-100 border-green-300';
                content.innerHTML = `<p class="text-2xl font-bold text-green-800">Tudo certo!</p><p>As contas estão zeradas.</p>`;
            } else {
                card.className = 'p-6 rounded-2xl shadow-lg text-center bg-blue-100 border-blue-300';
                const devedor = saldoPosAcertosA < 0 ? a : b;
                const credor = saldoPosAcertosA < 0 ? b : a;
                const valor = Math.abs(saldoPosAcertosA);
                content.innerHTML = `<p>Para zerar as contas:</p><p class="text-2xl font-bold my-2">${devedor} → ${credor}</p><p class="text-3xl font-bold">${fmt(valor)}</p>`;
            }
        }
        
        function renderLancamentos() {
            const tbody = document.getElementById('lancamentos-table-body');
            const filter = document.getElementById('filter-cc').value;
            const filtered = state.lancamentos.filter(l => filter === 'Todos' || l.cc === filter);
            tbody.innerHTML = filtered.map(l => `
                <tr class="border-b">
                    <td class="p-2">${l.dt}</td>
                    <td class="p-2">${l.desc}</td>
                    <td class="p-2">${fmt(l.valor)}</td>
                    <td class="p-2">${l.pagador}</td>
                    <td class="p-2">${l.anexo ? `<a href="${l.anexo.url}" target="_blank" class="text-blue-600 hover:underline">Ver</a>` : 'Não'}</td>
                    <td class="p-2"><button data-id="${l.id}" class="delete-lancamento-btn text-red-500 font-bold hover:text-red-700">X</button></td>
                </tr>
            `).join('');
        }

        function renderAcertos() {
            const list = document.getElementById('acertos-list');
            list.innerHTML = state.acertos.map(a => {
                const date = a.dt?.toDate ? new Date(a.dt.toDate()).toLocaleDateString('pt-BR') : '...';
                return `<li class="flex justify-between items-center p-2 bg-slate-100 rounded-md">
                    <span>${date}: <strong>${a.de}</strong> → <strong>${a.para}</strong> - ${fmt(a.valor)} ${a.anexo ? `<a href="${a.anexo.url}" target="_blank" class="text-blue-600 hover:underline">(anexo)</a>` : ''}</span>
                    <button data-id="${a.id}" class="delete-acerto-btn text-red-500 ml-4 font-bold hover:text-red-700">X</button>
                </li>`
            }).join('');
        }

        function renderResumoSocios() {
            const { a, b } = state.config;
            const { pagoPorA, devidoPorA, saldoPosAcertosA, pagoPorB, devidoPorB, saldoPosAcertosB } = cachedCalculations;
            const container = document.getElementById('resumo-socios');
            container.innerHTML = [
                { nome: a, pago: pagoPorA, devido: devidoPorA, saldo: saldoPosAcertosA },
                { nome: b, pago: pagoPorB, devido: devidoPorB, saldo: saldoPosAcertosB }
            ].map(s => `
                <div>
                    <h3 class="font-semibold text-lg">${s.nome}</h3>
                    <div class="text-sm space-y-1 mt-1">
                        <p class="flex justify-between"><span>Pago:</span> <span>${fmt(s.pago)}</span></p>
                        <p class="flex justify-between"><span>Devido:</span> <span>${fmt(s.devido)}</span></p>
                        <hr class="my-1"><p class="flex justify-between font-bold"><span>Saldo:</span> <span class="${s.saldo < 0 ? 'text-red-600' : 'text-green-600'}">${fmt(s.saldo)}</span></p>
                    </div>
                </div>`).join('');
        }

        function renderHistoryModal() {
            const content = document.getElementById('history-content');
            if(!content) return;
            content.innerHTML = state.history.map(log => {
                 const detailsText = log.details.desc ? `${log.details.desc} - ${log.details.valor}` : (log.details.valor || '');
                 return `<div class="p-2 border-b">
                    <p><strong>${log.action}</strong> por ${log.user}</p>
                    <p class="text-xs text-slate-500">${log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString('pt-BR') : ''}</p>
                    ${detailsText ? `<p class="text-xs text-gray-700">${detailsText}</p>` : ''}
                </div>`
            }).join('');
        }
        
        async function handleFileUpload(file, path) {
            if (!file) return null;
            try {
                const storageRef = ref(storage, `${path}/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);
                return { url, path: snapshot.ref.fullPath, name: file.name };
            } catch (error) {
                console.error("Upload Error:", error);
                alert(`Falha no upload do anexo.\n\nErro: ${error.code}\n\nPor favor, verifique as regras de segurança do Storage no seu painel do Firebase.`);
                throw error;
            }
        }
        
        function addEventListeners() {
            appWrapper.addEventListener('click', async e => {
                if (e.target.id === 'logout-btn') signOut(auth);
                if (e.target.matches('.delete-lancamento-btn')) {
                    const id = e.target.dataset.id;
                    if (confirm('Tem a certeza que deseja excluir este lançamento?')) {
                        const lancamento = state.lancamentos.find(l => l.id === id);
                        if (lancamento.anexo) await deleteObject(ref(storage, lancamento.anexo.path));
                        await deleteDoc(doc(db, "lancamentos", id));
                        await logEvent('Lançamento Excluído', { desc: lancamento.desc, valor: fmt(lancamento.valor) });
                    }
                }
                if (e.target.matches('.delete-acerto-btn')) {
                     const id = e.target.dataset.id;
                    if (confirm('Tem a certeza que deseja excluir este acerto?')) {
                        const acerto = state.acertos.find(a => a.id === id);
                        if (acerto.anexo) await deleteObject(ref(storage, acerto.anexo.path));
                        await deleteDoc(doc(db, "acertos", id));
                        await logEvent('Acerto Excluído', { valor: fmt(acerto.valor) });
                    }
                }
                if (e.target.id === 'quick-add-btn') document.getElementById('quick-add-modal').classList.remove('hidden');
                if (e.target.id === 'quick-add-cancel' || (e.target.id === 'quick-add-modal' && !e.target.closest('.bg-white'))) document.getElementById('quick-add-modal').classList.add('hidden');
                
                if (e.target.id === 'manage-budget-btn') {
                    const fields = document.getElementById('budget-fields');
                    const budget = state.config.budget || { cc: {} };
                    fields.innerHTML = PREDEFINED_LISTS.centrosDeCusto.map(cc => `<div><label class="block text-sm font-medium text-slate-700">${cc}</label><input type="text" name="${cc}" value="${budget.cc[cc] || ''}" class="mt-1 w-full border p-2 rounded-md" placeholder="R$ 0,00"></div>`).join('');
                    document.getElementById('budget-modal').classList.remove('hidden');
                }
                if (e.target.id === 'budget-cancel' || (e.target.id === 'budget-modal' && !e.target.closest('.bg-white'))) document.getElementById('budget-modal').classList.add('hidden');
                if (e.target.id === 'budget-save') {
                    const newBudget = { cc: {} };
                    document.querySelectorAll('#budget-fields input').forEach(i => newBudget.cc[i.name] = parseNum(i.value));
                    await setDoc(configDocRef, { budget: newBudget }, { merge: true });
                    await logEvent('Orçamento Atualizado');
                    document.getElementById('budget-modal').classList.add('hidden');
                }
                
                if (e.target.id === 'history-btn') document.getElementById('history-modal').classList.remove('hidden');
                if (e.target.id === 'history-close' || (e.target.id === 'history-modal' && !e.target.closest('.bg-white'))) document.getElementById('history-modal').classList.add('hidden');
            });
            
            document.getElementById('participant-a').addEventListener('change', async e => {
                await setDoc(configDocRef, { a: e.target.value }, { merge: true });
                await logEvent('Sócio A Alterado', { nome: e.target.value });
            });
            document.getElementById('participant-b').addEventListener('change', async e => {
                await setDoc(configDocRef, { b: e.target.value }, { merge: true });
                await logEvent('Sócio B Alterado', { nome: e.target.value });
            });

            document.getElementById('lancamento-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<div class="loader"></div> Adicionando...`;
                
                try {
                    const anexo = await handleFileUpload(form.anexo.files[0], 'lancamentos');
                    const lancamento = {
                        dt: form.dt.value, desc: form.desc.value, cat: form.cat.value, cc: form.cc.value,
                        valor: parseNum(form.valor.value), pagador: form.pagador.value,
                        pA: parseFloat(form.pA.value), pB: parseFloat(form.pB.value), anexo,
                        createdBy: currentUser.displayName, createdAt: serverTimestamp()
                    };
                    if(!lancamento.dt) throw new Error('A data é obrigatória.');
                    if(lancamento.valor <= 0) throw new Error('O valor deve ser positivo.');
                    await addDoc(lancamentosCol, lancamento);
                    await logEvent('Lançamento Adicionado', { desc: lancamento.desc, valor: fmt(lancamento.valor) });
                    form.reset();
                    document.getElementById('dt').valueAsDate = new Date();
                } catch (error) {
                    // Error is already alerted in handleFileUpload, just log it here
                    console.error("Form submission error:", error);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });
            
            document.getElementById('acerto-form').addEventListener('submit', async e => {
                e.preventDefault();
                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<div class="loader"></div> Registrando...`;

                try {
                    const valor = parseNum(form['valor-acerto'].value);
                    if (form.de.value === form.para.value) throw new Error('Pagador e recebedor devem ser diferentes.');
                    if (valor <= 0) throw new Error('O valor do acerto deve ser positivo.');
                    const anexo = await handleFileUpload(form['anexo-acerto'].files[0], 'acertos');
                    const acerto = { dt: serverTimestamp(), de: form.de.value, para: form.para.value, valor, anexo };
                    await addDoc(acertosCol, acerto);
                    await logEvent('Acerto Registado', { de: acerto.de, para: acerto.para, valor: fmt(acerto.valor) });
                    form.reset();
                } catch (error) {
                    // Error is already alerted in handleFileUpload, or it's a form error
                    if (error.message) alert(error.message);
                    console.error("Acerto form error:", error);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });
            
            document.getElementById('quick-add-form').addEventListener('submit', async e => {
                e.preventDefault();
                const form = e.target;
                const valor = parseNum(form['quick-valor'].value);
                if (valor <= 0) return alert('O valor deve ser positivo.');
                const lancamento = {
                    dt: new Date().toISOString().split('T')[0], desc: form['quick-desc'].value, cat: 'Outros', cc: 'Outros',
                    valor, pagador: form['quick-pagador'].value, pA: 0.5, pB: 0.5, anexo: null,
                    createdBy: currentUser.displayName, createdAt: serverTimestamp()
                };
                await addDoc(lancamentosCol, lancamento);
                await logEvent('Lanç. Rápido Adicionado', { desc: lancamento.desc, valor: fmt(lancamento.valor) });
                form.reset();
                document.getElementById('quick-add-modal').classList.add('hidden');
            });

            document.getElementById('filter-cc').addEventListener('change', rerender);
        }
    </script>
</body>
</html>

