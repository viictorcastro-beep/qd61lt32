<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>V&G – Gestor de Custos (Firebase + GitHub Pages)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF opcional -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,.06); padding: 20px; }
    .btn { padding: 10px 14px; border-radius: 12px; font-weight: 600; font-size: 14px; }
    .btn-prim { background: #0f172a; color: #fff; }
    .btn-prim:hover { background: #1f2937; }
    .btn-sec { background: #f3f4f6; }
    .btn-sec:hover { background: #e5e7eb; }
    .pill { border-radius: 9999px; padding: 2px 10px; font-size: 12px; background: #f3f4f6; }
    .hint { font-size: 12px; color: #6b7280; }
    .danger { color: #dc2626; }
  </style>
</head>
<body class="bg-slate-50">

  <!-- LOGIN -->
  <div id="login" class="min-h-screen flex items-center justify-center p-6">
    <div class="card max-w-sm w-full text-center">
      <h1 class="text-2xl font-bold mb-2">Gestor de Custos — V&G</h1>
      <p class="text-sm text-slate-600 mb-5">Acesse com Google para abrir o painel colaborativo.</p>
      <button id="btnLogin" class="btn btn-prim w-full flex items-center justify-center gap-3">
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.018,36.33,44,30.651,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
        Entrar com Google
      </button>
      <p id="loginMsg" class="hint mt-3"></p>
      <p class="hint mt-2">Dica: autorize <b>viictorcastro-beep.github.io</b> em Authentication → Settings → Authorized domains (Firebase).</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="max-w-7xl mx-auto p-5 lg:p-8">
      <header class="mb-6 flex items-center justify-between">
        <h1 class="text-2xl font-bold">Gestor de Custos — Victor & Gustavo</h1>
        <div class="flex items-center gap-3">
          <img id="userPhoto" class="w-8 h-8 rounded-full" alt="" />
          <span id="userName" class="text-sm"></span>
          <button id="btnExportCSV" class="btn btn-sec">Exportar CSV</button>
          <label class="btn btn-sec cursor-pointer">
            Importar CSV <input id="fileImport" type="file" accept=".csv" class="hidden" />
          </label>
          <button id="btnLogout" class="btn btn-sec">Sair</button>
        </div>
      </header>

      <!-- Participantes + KPIs -->
      <section class="card mb-6">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-500">Participante A</label>
            <input id="nameA" class="w-full border rounded-xl p-2" value="Victor" />
          </div>
          <div>
            <label class="text-xs text-slate-500">Participante B</label>
            <input id="nameB" class="w-full border rounded-xl p-2" value="Gustavo" />
          </div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="card bg-slate-900 text-white">
            <div class="text-xs opacity-80">Total Geral</div>
            <div id="kpiTotal" class="text-2xl font-bold">R$ 0,00</div>
          </div>
          <div class="card">
            <div class="text-xs text-slate-500">Pago — <span id="lblA">Victor</span></div>
            <div id="kpiPagoA" class="text-2xl font-bold">R$ 0,00</div>
          </div>
          <div class="card">
            <div class="text-xs text-slate-500">Pago — <span id="lblB">Gustavo</span></div>
            <div id="kpiPagoB" class="text-2xl font-bold">R$ 0,00</div>
          </div>
          <div class="card">
            <div class="text-xs text-slate-500">Equalização sugerida</div>
            <div class="text-sm">Se > 0, <b id="whoPays"></b> paga</div>
            <div id="kpiEqual" class="text-2xl font-bold">R$ 0,00</div>
          </div>
        </div>
      </section>

      <!-- Novo lançamento -->
      <section class="card mb-6">
        <h2 class="text-lg font-semibold mb-3">Novo Lançamento</h2>
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-12 md:col-span-2">
            <label class="text-xs text-slate-500">Data</label>
            <input id="iData" type="date" class="w-full border rounded-xl p-2" />
          </div>
          <div class="col-span-12 md:col-span-4">
            <label class="text-xs text-slate-500">Descrição</label>
            <input id="iDesc" class="w-full border rounded-xl p-2" placeholder="Ex.: Quitação terreno QD31 LT32" />
          </div>
          <div class="col-span-12 md:col-span-2">
            <label class="text-xs text-slate-500">Categoria</label>
            <select id="iCat" class="w-full border rounded-xl p-2"></select>
          </div>
          <div class="col-span-12 md:col-span-2">
            <label class="text-xs text-slate-500">Centro de Custo</label>
            <select id="iCC" class="w-full border rounded-xl p-2"></select>
          </div>
          <div class="col-span-12 md:col-span-2">
            <label class="text-xs text-slate-500">Valor (R$)</label>
            <input id="iValor" type="text" inputmode="decimal" class="w-full border rounded-xl p-2" placeholder="Ex.: 1.234,56" />
            <div class="hint">Use vírgula para centavos</div>
          </div>
          <div class="col-span-12 md:col-span-2">
            <label class="text-xs text-slate-500">Pagador</label>
            <select id="iPagador" class="w-full border rounded-xl p-2"></select>
          </div>
          <div class="col-span-6 md:col-span-1">
            <label class="text-xs text-slate-500">% A</label>
            <input id="iPercA" type="number" step="0.01" min="0" max="1" class="w-full border rounded-xl p-2" value="0.5" />
          </div>
          <div class="col-span-6 md:col-span-1">
            <label class="text-xs text-slate-500">% B</label>
            <input id="iPercB" type="number" step="0.01" min="0" max="1" class="w-full border rounded-xl p-2" value="0.5" />
          </div>
          <div class="col-span-12 md:col-span-2">
            <label class="text-xs text-slate-500">Tipo Doc</label>
            <select id="iTipoDoc" class="w-full border rounded-xl p-2"></select>
          </div>
          <div class="col-span-12 md:col-span-2">
            <label class="text-xs text-slate-500">Nº Doc</label>
            <input id="iNumDoc" class="w-full border rounded-xl p-2" placeholder="ID/NSU/Nota" />
          </div>
          <div class="col-span-12 md:col-span-2">
            <label class="text-xs text-slate-500">Forma Pgto</label>
            <select id="iForma" class="w-full border rounded-xl p-2"></select>
          </div>
          <div class="col-span-12 md:col-span-2">
            <label class="text-xs text-slate-500">Status</label>
            <select id="iStatus" class="w-full border rounded-xl p-2"></select>
          </div>
          <div class="col-span-12 md:col-span-4">
            <label class="text-xs text-slate-500">Comprovante (URL)</label>
            <input id="iLink" class="w-full border rounded-xl p-2" placeholder="https://..." />
          </div>
          <div class="col-span-12">
            <label class="text-xs text-slate-500">Observações</label>
            <input id="iObs" class="w-full border rounded-xl p-2" placeholder="Notas adicionais" />
          </div>
        </div>
        <div class="mt-4 flex gap-2 items-center">
          <button id="btnAdd" class="btn btn-prim">Adicionar</button>
          <button id="btnAddTerreno" class="btn btn-sec">Lançar Terreno (R$ 45.000 – Victor)</button>
          <span id="formMsg" class="hint"></span>
        </div>
      </section>

      <!-- Lançamentos + Acertos -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="card lg:col-span-2 overflow-x-auto">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Lançamentos</h2>
            <div class="hint">Sem comprovante, sem reembolso.</div>
          </div>
          <table class="w-full">
            <thead class="text-xs text-slate-500">
              <tr class="border-b">
                <th class="py-2 text-left">Data</th>
                <th class="py-2 text-left">Descrição</th>
                <th class="py-2 text-left">Categoria</th>
                <th class="py-2 text-left">Centro</th>
                <th class="py-2 text-right">Valor</th>
                <th class="py-2 text-left">Pagador</th>
                <th class="py-2 text-center">%A</th>
                <th class="py-2 text-center">%B</th>
                <th class="py-2 text-left">Tipo</th>
                <th class="py-2 text-left">Nº</th>
                <th class="py-2 text-left">Forma</th>
                <th class="py-2 text-left">Status</th>
                <th class="py-2 text-left">Comprovante</th>
                <th class="py-2"></th>
              </tr>
            </thead>
            <tbody id="tBody"></tbody>
          </table>
        </div>

        <div class="card">
          <h2 class="text-lg font-semibold mb-3">Acertos (transferências)</h2>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-xs text-slate-500">De</label>
              <select id="accDe" class="w-full border rounded-xl p-2"></select>
            </div>
            <div>
              <label class="text-xs text-slate-500">Para</label>
              <select id="accPara" class="w-full border rounded-xl p-2"></select>
            </div>
            <div class="col-span-2">
              <label class="text-xs text-slate-500">Valor (R$)</label>
              <input id="accValor" type="text" inputmode="decimal" class="w-full border rounded-xl p-2" placeholder="Ex.: 22.500,00" />
            </div>
            <div class="col-span-2">
              <label class="text-xs text-slate-500">Link do comprovante</label>
              <input id="accLink" class="w-full border rounded-xl p-2" placeholder="https://..." />
            </div>
          </div>
          <div class="flex gap-2 mb-4">
            <button id="btnAddAcc" class="btn btn-prim">Registrar Acerto</button>
            <button id="btnSugestao" class="btn btn-sec">Usar Sugestão</button>
          </div>
          <div>
            <h3 class="text-sm font-semibold mb-2">Histórico</h3>
            <ul id="accList" class="space-y-2 text-sm"></ul>
          </div>
        </div>
      </section>

      <!-- Resumo -->
      <section class="card">
        <h2 class="text-lg font-semibold mb-3">Resumo</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <div class="text-xs text-slate-500">Total Geral</div>
            <div id="rTotal" class="text-xl font-bold">R$ 0,00</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Devido (50%) — <span id="lblA2">Victor</span></div>
            <div id="rDevA" class="text-xl font-bold">R$ 0,00</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Devido (50%) — <span id="lblB2">Gustavo</span></div>
            <div id="rDevB" class="text-xl font-bold">R$ 0,00</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Pago — <span id="lblA3">Victor</span></div>
            <div id="rPagoA" class="text-xl font-bold">R$ 0,00</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Pago — <span id="lblB3">Gustavo</span></div>
            <div id="rPagoB" class="text-xl font-bold">R$ 0,00</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Saldo — <span id="lblA4">Victor</span> (pós-acertos)</div>
            <div id="rSaldoA" class="text-xl font-bold">R$ 0,00</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Saldo — <span id="lblB4">Gustavo</span> (pós-acertos)</div>
            <div id="rSaldoB" class="text-xl font-bold">R$ 0,00</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Firebase (modular v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, deleteDoc, onSnapshot, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

// Lista branca
const ALLOW = new Set([
  'viictor.castro@gmail.com',
  'gcm.conceicao@gmail.com'
]);

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const email = (user.email || '').toLowerCase();

    // Bloqueio visual imediato
    if (!ALLOW.has(email)) {
      document.querySelector('#loginMsg').innerHTML =
        'Acesso negado: este e-mail não está autorizado.';
      await signOut(auth); // garante sair
      return;
    }

    // ... segue fluxo normal se autorizado
    document.getElementById('login').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('userPhoto').src = user.photoURL || '';
    document.getElementById('userName').textContent = user.displayName || email;

    // resto do init (preencher selects, listeners realtime, etc.)
    startRealtime();
    const d = document.getElementById('iData');
    if (d && !d.value) d.value = new Date().toISOString().slice(0,10);
  } else {
    document.getElementById('app').classList.add('hidden');
    document.getElementById('login').classList.remove('hidden');
  }
});


    // ---- CONFIG (ajuste se seu projeto for outro) ----
    const firebaseConfig = {
      apiKey: "AIzaSyA9GTueuXozK7FZPl-MSnXfbn4d9ex2Mm8",
      authDomain: "qd61lt32.firebaseapp.com",
      projectId: "qd61lt32",
      storageBucket: "qd61lt32.appspot.com",
      messagingSenderId: "636694484879",
      appId: "1:636694484879:web:9f321f56f1e72895c25dfa",
      measurementId: "G-QT2KJL124T"
    };

    // ---- INIT ----
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ---- Helpers ----
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const toBRL = (n) => Number(n || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    const round2 = (x) => Math.round((Number(x) || 0) * 100) / 100;
    const parseMoney = (v) => { if (v == null) return 0; const s = String(v).trim(); if (!s) return 0; const cleaned = s.replace(/[^\d,.-]/g, "").replace(/\.(?=\d{3}(\D|$))/g, ""); return parseFloat(cleaned.replace(",", ".")) || 0; };
    const pctClamp = (x) => { const n = Number(x); if (isNaN(n)) return 0.5; return Math.min(1, Math.max(0, n)); };

    // ---- Collections ----
    const colLanc = collection(db, "lancamentos");
    const colAcertos = collection(db, "acertos");
    const docConfig = doc(db, "config", "main");

    // ---- Estado ----
    const state = { a: "Victor", b: "Gustavo", lanc: [], acertos: [], user: null };

    // ---- Listas fixas ----
    const CATS = ["Terreno","Projeto","Material","Mão de Obra","Serviços","Licenças/Taxas","Transporte/Logística","Outros"];
    const CC = ["Terreno","Projeto","Fundações","Estrutura/Alvenaria","Cobertura","Elétrica","Hidráulica","Revestimentos/Pisos","Esquadrias/Vidros","Pintura","Paisagismo","Licenças/Taxas","Equalização","Outros"];
    const TIPODOC = ["NF-e (produto)","NFS-e (serviço)","Recibo","RPA","Sem documento"];
    const FORMA = ["PIX","Cartão (crédito)","Cartão (débito)","Boleto","Dinheiro","Transferência"];
    const STATUS = ["Aguardando aprovação","Aprovado","Pago","Conciliado","Reembolsado"];
    const fill = (el, arr) => el.innerHTML = arr.map(v => `<option value="${v}">${v}</option>`).join("");

    // ---- AUTH (forçar POPUP em GitHub Pages) ----
async function doLogin() {
  try {
    // popup resolve em GitHub Pages sem exigir /__/auth/handler
    await signInWithPopup(auth, provider);
  } catch (e) {
    const code = e?.code || "";
    // Mensagem clara pro caso de domínio não autorizado
    if (code === "auth/unauthorized-domain") {
      document.querySelector("#loginMsg").innerHTML =
        'Domínio não autorizado no Firebase Auth. Em <b>Authentication → Settings → Authorized domains</b> adicione <b>viictorcastro-beep.github.io</b>.';
      return;
    }
    if (code.includes("popup-blocked") || code.includes("popup-closed")) {
      document.querySelector("#loginMsg").textContent =
        "Seu navegador bloqueou o popup. Libere popups para este site e tente de novo.";
      return;
    }
    document.querySelector("#loginMsg").textContent = e.message || String(e);
  }
}

document.querySelector("#btnLogin").addEventListener("click", doLogin);
document.querySelector("#btnLogout").addEventListener("click", () => signOut(auth));




    // ---- Realtime ----
    let unsubLanc = null, unsubAc = null, unsubCfg = null;
    function startRealtime() {
      if (unsubLanc) unsubLanc(); if (unsubAc) unsubAc(); if (unsubCfg) unsubCfg();

      unsubLanc = onSnapshot(query(colLanc, orderBy("dt", "asc")), (snap) => {
        state.lanc = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        compute();
      });
      unsubAc = onSnapshot(query(colAcertos, orderBy("dt", "asc")), (snap) => {
        state.acertos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        compute();
      });
      unsubCfg = onSnapshot(docConfig, (d) => {
        if (d.exists()) {
          const c = d.data();
          state.a = c.a || state.a;
          state.b = c.b || state.b;
        } else {
          setDoc(docConfig, { a: state.a, b: state.b }, { merge: true });
        }
        refreshLabels(); compute();
      });
    }

    // ---- UI: nomes/labels ----
    function refreshLabels() {
      $$("#lblA, #lblA2, #lblA3, #lblA4").forEach(n => n.textContent = state.a);
      $$("#lblB, #lblB2, #lblB3, #lblB4").forEach(n => n.textContent = state.b);
      fill($("#iPagador"), [state.a, state.b]);
      fill($("#accDe"), [state.a, state.b]);
      fill($("#accPara"), [state.a, state.b]);
      $("#nameA").value = state.a; $("#nameB").value = state.b;
    }

    $("#nameA").addEventListener("input", async () => {
      state.a = $("#nameA").value || "A";
      await setDoc(docConfig, { a: state.a }, { merge: true });
      refreshLabels(); compute();
    });
    $("#nameB").addEventListener("input", async () => {
      state.b = $("#nameB").value || "B";
      await setDoc(docConfig, { b: state.b }, { merge: true });
      refreshLabels(); compute();
    });

    // ---- Lançamentos: add / delete ----
    function msg(text, isError = false) {
      const el = $("#formMsg");
      el.textContent = text;
      el.className = `hint ${isError ? "danger" : ""}`;
      if (text) setTimeout(() => { el.textContent = ""; el.className = "hint"; }, 2500);
    }

    $("#btnAdd").addEventListener("click", async () => {
      const rec = {
        dt: $("#iData").value || new Date().toISOString().slice(0, 10),
        desc: ($("#iDesc").value || "").trim(),
        cat: $("#iCat").value, cc: $("#iCC").value,
        valor: round2(parseMoney($("#iValor").value)),
        pagador: $("#iPagador").value,
        pA: pctClamp($("#iPercA").value), pB: pctClamp($("#iPercB").value),
        tipo: $("#iTipoDoc").value, num: $("#iNumDoc").value,
        forma: $("#iForma").value, status: $("#iStatus").value,
        link: $("#iLink").value, obs: $("#iObs").value,
        createdBy: state.user?.displayName || state.user?.email || "",
        createdAt: serverTimestamp()
      };
      if (!rec.desc) return msg("Informe a descrição", true);
      if (!rec.valor || rec.valor <= 0) return msg("Valor deve ser positivo", true);
      if (rec.pA + rec.pB > 1.0001) return msg("Soma de %A + %B não pode exceder 1.0", true);
      try {
        await addDoc(colLanc, rec);
        $$("#iDesc,#iValor,#iNumDoc,#iLink,#iObs").forEach(i => i.value = "");
        msg("Lançamento adicionado");
      } catch (e) { alert("Erro ao salvar lançamento: " + (e?.code || e?.message || e)); }
    });

    $("#btnAddTerreno").addEventListener("click", async () => {
      const hoje = new Date().toISOString().slice(0, 10);
      const base = { cat: "Terreno", cc: "Terreno", pagador: state.a, pA: 0.5, pB: 0.5, tipo: "Recibo", num: "PIX", forma: "PIX", status: "Conciliado", link: "", obs: "" };
      try {
        await addDoc(colLanc, { ...base, dt: hoje, desc: "Entrada terreno QD31 LT32", valor: 5000, createdBy: state.user?.email || "", createdAt: serverTimestamp() });
        await addDoc(colLanc, { ...base, dt: hoje, desc: "Quitação terreno QD31 LT32", valor: 40000, createdBy: state.user?.email || "", createdAt: serverTimestamp() });
      } catch (e) { alert("Erro ao lançar terreno: " + (e?.code || e?.message || e)); }
    });

    $("#tBody").addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-id]");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      if (confirm("Excluir lançamento?")) {
        try { await deleteDoc(doc(db, "lancamentos", id)); }
        catch (e) { alert("Erro ao excluir: " + (e?.code || e?.message || e)); }
      }
    });

    // ---- Acertos: add / delete ----
    $("#btnAddAcc").addEventListener("click", async () => {
      const de = $("#accDe").value, para = $("#accPara").value;
      const valor = round2(parseMoney($("#accValor").value));
      const link = $("#accLink").value;
      if (!valor || valor <= 0 || !de || !para || de === para) return alert("Verifique valor e participantes.");
      try {
        await addDoc(colAcertos, { de, para, valor, link, dt: new Date().toISOString().slice(0, 10), createdBy: state.user?.email || "", createdAt: serverTimestamp() });
        $("#accValor").value = ""; $("#accLink").value = "";
      } catch (e) { alert("Erro ao registrar acerto: " + (e?.code || e?.message || e)); }
    });

    $("#btnSugestao").addEventListener("click", async () => {
      const eq = $("#kpiEqual").textContent;
      const quem = $("#whoPays").textContent;
      const v = prompt(`Transferência sugerida (de ${quem}):`, eq.replace(/[^0-9.,-]/g, ""));
      const num = round2(parseMoney(v));
      if (num > 0 && quem) {
        const de = quem;
        const para = (quem === state.a ? state.b : state.a);
        try {
          await addDoc(colAcertos, { de, para, valor: num, link: "", dt: new Date().toISOString().slice(0, 10), createdAt: serverTimestamp() });
        } catch (e) { alert("Erro ao salvar acerto: " + (e?.code || e?.message || e)); }
      }
    });

    $("#accList").addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-id]");
      if (!btn) return; const id = btn.getAttribute("data-id");
      if (confirm("Excluir acerto?")) {
        try { await deleteDoc(doc(db, "acertos", id)); }
        catch (e) { alert("Erro ao excluir acerto: " + (e?.code || e?.message || e)); }
      }
    });

    // ---- Render ----
    function renderTable() {
      const tb = $("#tBody"); tb.innerHTML = "";
      const rows = [...state.lanc].sort((a, b) => String(a.dt || "").localeCompare(String(b.dt || "")));
      rows.forEach(r => {
        const tr = document.createElement("tr"); tr.className = "border-b hover:bg-slate-50";
        const pA = (r.pA ?? 0.5), pB = (r.pB ?? 0.5);
        tr.innerHTML = `
          <td class="py-2">${r.dt || ""}</td>
          <td>${r.desc || ""}</td>
          <td><span class="pill">${r.cat || ""}</span></td>
          <td>${r.cc || ""}</td>
          <td class="text-right">${toBRL(r.valor || 0)}</td>
          <td>${r.pagador || ""}</td>
          <td class="text-center">${Math.round(pA * 100)}%</td>
          <td class="text-center">${Math.round(pB * 100)}%</td>
          <td>${r.tipo || ""}</td>
          <td>${r.num || ""}</td>
          <td>${r.forma || ""}</td>
          <td>${r.status || ""}</td>
          <td>${r.link ? `<a class="text-blue-700 underline" href="${r.link}" target="_blank" rel="noopener">abrir</a>` : ""}</td>
          <td><button data-id="${r.id}" class="btn btn-sec text-xs">Excluir</button></td>`;
        tb.appendChild(tr);
      });
    }

    function renderAcertos() {
      const ul = $("#accList"); ul.innerHTML = "";
      const rows = [...state.acertos].sort((a, b) => String(a.dt || "").localeCompare(String(b.dt || "")));
      rows.forEach(a => {
        const li = document.createElement("li");
        li.innerHTML = `<div class="flex items-center justify-between">
          <div><span class="pill">${a.dt || ""}</span> <b>${a.de}</b> → <b>${a.para}</b> • ${toBRL(a.valor)} ${a.link ? `• <a class="text-blue-700 underline" href="${a.link}" target="_blank" rel="noopener">comprovante</a>` : ""}</div>
          <button data-id="${a.id}" class="btn btn-sec text-xs">Excluir</button>
        </div>`;
        ul.appendChild(li);
      });
    }

    function compute() {
      const total = round2(state.lanc.reduce((s, r) => s + Number(r.valor || 0), 0));
      const pagoA = round2(state.lanc.filter(r => r.pagador === state.a).reduce((s, r) => s + Number(r.valor || 0), 0));
      const pagoB = round2(state.lanc.filter(r => r.pagador === state.b).reduce((s, r) => s + Number(r.valor || 0), 0));
      const devA = round2(state.lanc.reduce((s, r) => s + Number(r.valor || 0) * (r.pA != null ? pctClamp(r.pA) : 0.5), 0));
      const devB = round2(state.lanc.reduce((s, r) => s + Number(r.valor || 0) * (r.pB != null ? pctClamp(r.pB) : 0.5), 0));

      const saldoA_bruto = round2(pagoA - devA);
      const saldoB_bruto = round2(pagoB - devB);

      const recA = round2(state.acertos.filter(a => a.para === state.a).reduce((s, a) => s + Number(a.valor || 0), 0));
      const pagA = round2(state.acertos.filter(a => a.de === state.a).reduce((s, a) => s + Number(a.valor || 0), 0));
      const recB = round2(state.acertos.filter(a => a.para === state.b).reduce((s, a) => s + Number(a.valor || 0), 0));
      const pagB = round2(state.acertos.filter(a => a.de === state.b).reduce((s, a) => s + Number(a.valor || 0), 0));

      const saldoA = round2(saldoA_bruto + recA - pagA);
      const saldoB = round2(saldoB_bruto + recB - pagB);

      let sugerido = 0; let quemPaga = "";
      if (saldoA > 0 && saldoB < 0) { sugerido = Math.min(saldoA, -saldoB); quemPaga = state.b; }
      else if (saldoB > 0 && saldoA < 0) { sugerido = Math.min(saldoB, -saldoA); quemPaga = state.a; }

      // KPIs
      $("#kpiTotal").textContent = toBRL(total);
      $("#kpiPagoA").textContent = toBRL(pagoA);
      $("#kpiPagoB").textContent = toBRL(pagoB);
      $("#kpiEqual").textContent = toBRL(sugerido);
      $("#whoPays").textContent = quemPaga || "";

      // Resumo
      $("#rTotal").textContent = toBRL(total);
      $("#rDevA").textContent = toBRL(devA);
      $("#rDevB").textContent = toBRL(devB);
      $("#rPagoA").textContent = toBRL(pagoA);
      $("#rPagoB").textContent = toBRL(pagoB);
      $("#rSaldoA").textContent = toBRL(saldoA);
      $("#rSaldoB").textContent = toBRL(saldoB);

      renderTable();
      renderAcertos();
    }

    // ---- CSV ----
    function exportCSV() {
      const esc = (v) => `"${String(v ?? "").replaceAll('"', '""')}"`;
      const head = ["dt","desc","cat","cc","valor","pagador","pA","pB","tipo","num","forma","status","link","obs"];
      const rows = state.lanc.map(r => head.map(k => esc(r[k])).join(","));
      const csv = [head.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob); a.download = "lancamentos.csv"; a.click();
    }
    async function importCSV(file) {
      const reader = new FileReader();
      reader.onload = async () => {
        const text = reader.result; if (!text) return;
        const lines = String(text).split(/\r?\n/).filter(Boolean);
        if (!lines.length) return;
        const head = lines.shift().split(",").map(h => h.replaceAll('"', "").trim());
        const to = (s) => String(s || "").replace(/^\"|\"$/g, "").replaceAll('""','"');
        for (const line of lines) {
          const cells = line.match(/(?:\"[^\"]*\"|[^,])+/g) || [];
          const rec = {}; head.forEach((h, i) => rec[h] = to(cells[i] || ""));
          try {
            await addDoc(colLanc, {
              dt: rec.dt || new Date().toISOString().slice(0, 10),
              desc: (rec.desc || "").trim(),
              cat: rec.cat || "Outros", cc: rec.cc || "Outros",
              valor: round2(parseMoney(rec.valor)),
              pagador: rec.pagador || state.a,
              pA: pctClamp(rec.pA), pB: pctClamp(rec.pB),
              tipo: rec.tipo || "", num: rec.num || "", forma: rec.forma || "", status: rec.status || "", link: rec.link || "", obs: rec.obs || "",
              createdBy: state.user?.email || "", createdAt: serverTimestamp()
            });
          } catch (e) { console.error("CSV linha com erro:", e); }
        }
      };
      reader.readAsText(file, "utf-8");
    }
    $("#btnExportCSV").addEventListener("click", exportCSV);
    $("#fileImport").addEventListener("change", (e) => { if (e.target.files[0]) importCSV(e.target.files[0]); });

    // ---- Aviso amigável se domínio não estiver autorizado ----
    if (location.hostname.endsWith("github.io")) {
      // Ajuda quando esquecemos de autorizar o domínio no Firebase
      auth.onAuthStateChanged(()=>{}, (e)=>{
        if (e?.code === "auth/unauthorized-domain") {
          $("#loginMsg").innerHTML = "Domínio não autorizado. Adicione <b>viictorcastro-beep.github.io</b> em Authorized domains (Firebase).";
        }
      });
    }
  </script>
</body>
</html>